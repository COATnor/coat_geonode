{% extends "newdata/newdata_base.html" %}
{% load i18n %}
{% load staticfiles %}
{% load dialogos_tags %}
{% load agon_ratings_tags %}
{% load bootstrap_tags %}
{% load pagination_tags %}
{% load url from future %}
{% load base_tags %}
{% load guardian_tags %}

{% block title %} Moth {% endblock %}


<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>



{% block body_outer %}
    {% include "newdata/newdata_ol3_map.html" %}

    <script>
        var geojsonFormat = new ol.format.GeoJSON();

        function show_data(waypoint) {

            $.ajax({
                type: "POST",
                url: 'newdata/mothwaypoints/'+waypoint+'/',
                data: {waypoint: waypoint},
                dataType: 'json',
                success: function (data) {

                    var new_records = data['records'];
                    var parsed = JSON.parse(new_records)

                    div_rec = document.getElementById('new_records');
                    div_rec.innerHTML = '';

                    for (i = 0; i < new_records.length; i++) {
                        var newtr = document.createElement('tr');
                        div_rec.appendChild(newtr);

                        newtr.innerHTML = '<td>'+ parsed[i]['fields']['alt']+'</td>'+'<td>'+ parsed[i]['fields']['ep'] +'</td>'+'<td>'+ parsed[i]['fields']['opl'] +'</td>'+'<td>'+  parsed[i]['fields']['opint']+'</td>'+'<td>'+  parsed[i]['fields']['opdark']+'</td>'+'<td>'+ parsed[i]['fields']['opsum'] +'</td>'+'<td>'+ parsed[i]['fields']['agr'] +'</td>'+'<td>'+  parsed[i]['fields']['obs']+'</td>'+'<td>'+  parsed[i]['fields']['branches']+'</td>' +'<td>'+  parsed[i]['fields']['notes']+'</td>'
                    }


                }
                });

        }

        function filter_location(location) {
            $.ajax({
                type: "POST",
                url: location+'/',
                dataType: 'json',
                success: function (response) {

                    ways = response['way'];
                    records = response['rec'];


                    new_features = geojsonFormat.readFeatures(ways,
                        {featureProjection:"EPSG:3857"});

                    var y = new_features[0].get('lat');
                    var x = new_features[0].get('lon');
                    var coordinates = [x, y]
                    var lonlat = ol.proj.transform(coordinates, 'EPSG:4326', 'EPSG:3857')
                    new_lon = lonlat[0]
                    new_lat = lonlat[1]

                    layersource = waypoints_layer.getSource()
                    layersource.forEachFeature(function(feature){
                        layersource.removeFeature(feature)
                    });

                    layersource.addFeatures(new_features)
                    map.getView().setCenter([new_lon, new_lat])



                    div = document.getElementById('waypoints');
                    div.innerHTML = '';
                    try {
                        div_rec.innerHTML = '';
                    } catch (e) {}

                    for (i = 0; i < new_features.length; i++) {
                        var newdiv = document.createElement('div');
                        div.appendChild(newdiv);
                        name = new_features[i].get('waypoint_name');
                        id = new_features[i].get('waypoint_id');

                        newdiv.innerHTML = '<button class="btn btn-default btn-block" onclick="show_data(\''+ name + '\')">' + name + '</button>'

                    }


                }
            });
        }
    </script>


<div class="container-fluid">
    <hr class="">
    <div class="row">
        <div class="col-md-2">
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h3 class="">Locations</h3>
                </div>
                 {% for loc in mothloc %}
                    <div>
                        <button onclick="filter_location('{{ loc }}');" class="btn btn-default btn-block">{{ loc }}  </button>
                    </div>
                 {% endfor %}
            </div>
        </div>
        <div class="col-md-6">
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h3 class="">Map</h3>
                </div>

                <div id="embedded_map" class="mrg-btm">
                    <div id="preview_map"></div>
                </div>

                <table class="table">
                    <thead>
                      <tr>
                          <th>alt</th>
                          <th>ep</th>
                          <th>opl</th>
                          <th>opint</th>
                          <th>opdark</th>
                          <th>opsum</th>
                          <th>agr</th>
                          <th>obs</th>
                          <th>branches</th>
                          <th>notes</th>
                      </tr>
                    </thead>
                    <tbody id="new_records">

                    </tbody>
                </table>

            </div>
        </div>
        <div class="col-md-4">
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h3 class="">Waypoints</h3>
                </div>

                <div id="waypoints">
                </div>

            </div>
        </div>
    </div>
</div>



<div class="row">

    <div class="col-md-8">
        <!--<div class="col-8">
            <div id="map">
                <script type="text/javascript">

                    function main_map_init(map, options) {
                        var geojsonPointLayer = new L.GeoJSON.AJAX("{% url 'mothgeojson' %}", {
                            onEachFeature:function(feature, layer) {
                                layer.bindPopup(feature.properties.name.toString()+'<br><img src="'
                                 + feature.properties.photo + '" /><br><a href="'+ feature.properties.institutional_link+'">Institution Link</a>'+
                                '<br><a href='+ feature.properties.social_link.toString()+'>Social Link</a>');
                            }
                        });
                        map.setView([63.43, 10.395], 5)
                        geojsonPointLayer.addTo(map)
                    }
                </script>
            </div>
        </div>-->


        <div id="embedded_map" class="mrg-btm">
          <div id="preview_map"></div>
        </div>
    </div>
</div>



<!--
alert(Object.keys(new_records));
 layersource.set('url', this.url);
alert(this.url);
alert(response.features[1].properties['waypoint_name']);

 alert(features);
            layersource.setProperties({url: this.url});
           layersource.clear()

        layersource = waypoints_layer.getSource()
                        layersource.forEachFeature(function(feature){
                           layersource.removeFeature(feature)
                        });
                        waypoints_layer.getSource(response);
                        waypoints_layer.source.dispatchEvent('change');

        var myVar1=data.features[0].properties['avgtemp1'];
        document.getElementById("v1").innerHTML = myVar1;


    <script>
        function filter_location(location) {
            $.get(location+'/', function (data) {
                alert("waypoints filtered!");
                alert(response.content);
            });
        }
    </script>
-->

{% endblock %}